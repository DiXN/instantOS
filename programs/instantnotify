#!/bin/bash

#######################################
## notification center for instantOS ##
#######################################

# show notification history in rofi
# enter to open a submenu for reading and deleting
# esc to exit

if ! [ -e /tmp/notifications/notif.txt ]; then
    echo "creating notification dir"
    mkdir /tmp/notifications
    cd /tmp/notifications
    echo "press enter to open submenu" >notif.txt
fi

cd /tmp/notifications

notifmenu() {
    sed 's/^/:b /g' | instantmenu -c -l 18 -h -1 -p "notifications" -q "search notifications" -bw 4 -a 4 | grep -o '(.*'
}

NREAD=$(tac notif.txt | notifmenu)

while [ -n "$NREAD" ]; do
    echo "$NREAD" | grep -o '(.*' |
        sed 's/^(\([0-9]*:[0-9]*\)) \[\(.*\)\] \(.*\) | \(.*\)/:g App:  \2\ntime: \1\n      \3\n      \4\n/g ' |
        sed 's/&amp;/&/g' | sed '/^[^:]/s/^/>/g' | sed -e '$a:b Back\n:r Delete\n:y Close' |
        instantmenu -c -l 18 -h -1 -q "notification" -bw 4 -a 4 >/tmp/notifications/selection
    SELECTION="$(cat /tmp/notifications/selection)"
    [ -z "$SELECTION" ] && exit
    case "$SELECTION" in
    *Delete)
        grep -vF "$NREAD" notif.txt >tmp.notif && mv tmp.notif notif.txt
        ;;
    *Close)
        exit
        ;;
    *Back)
        echo "back"
        ;;
    *)
        echo "app"
        echo "$SELECTION" | sed 's/..........\(.*\)/\1/g'
        exit
        ;;
    esac

    NREAD=$(tac notif.txt | notifmenu)
done
